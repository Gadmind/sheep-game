# 🔧 覆盖检测修复说明

## 问题描述

**用户反馈：**
> "堆叠后上方的卡片没被选走，下方遮罩的区域牌也不能选择"

**问题分析：**
- 覆盖检测算法判定过于严格
- 50%阈值导致偏移卡片无法正确覆盖下层
- 边界判断逻辑需要优化

---

## 🎯 修复方案

### 1. 中心点检测算法

**核心思想：**
如果下层卡片的**中心点**落在上层卡片的范围内，则被覆盖。

**示例：**
```
上层卡片A在(1.5, 1.5)，范围：[1.5, 2.5] × [1.5, 2.5]

下层卡片检测：
- 卡片(1,1)中心(1.5, 1.5) → 在范围内 ✓ 被覆盖
- 卡片(1,2)中心(1.5, 2.5) → 在范围内 ✓ 被覆盖
- 卡片(2,1)中心(2.5, 1.5) → 在范围内 ✓ 被覆盖
- 卡片(2,2)中心(2.5, 2.5) → 在范围内 ✓ 被覆盖
- 卡片(0,0)中心(0.5, 0.5) → 不在范围内 ✗ 未覆盖
- 卡片(3,3)中心(3.5, 3.5) → 不在范围内 ✗ 未覆盖
```

### 2. 降低面积阈值

**从50%降低到25%：**
- 原阈值（50%）：过于严格，偏移卡片无法覆盖
- 新阈值（25%）：更宽松，符合金字塔效果

**计算示例：**
```
上层(1.5, 1.5) vs 下层(1, 1)
重叠区域：[1.5, 2] × [1.5, 2] = 0.5 × 0.5 = 0.25
下层面积：1.0
重叠率：25%
判定：25% >= 25% ✓ 被覆盖
```

### 3. 边界判断优化

**使用 >= 和 <= ：**
```javascript
// 修复前（过于严格）
lowerCenterRow > upperTop && lowerCenterRow < upperBottom

// 修复后（包含边界）
lowerCenterRow >= upperTop && lowerCenterRow <= upperBottom
```

**效果：**
- 中心点刚好在边界上也算覆盖
- 更符合视觉直觉

---

## 🧪 验证方法

### 快速测试

刷新浏览器后，在控制台运行：

```javascript
// 1. 查看覆盖统计
debugCoverage()
```

**预期输出：**
```
=== 卡片覆盖关系调试 ===
总卡片: 96
可见: 20-30 (20-30%)
被覆盖: 66-76 (70-80%)
```

### 详细测试

```javascript
// 2. 查看偏移卡片
debugOffsetCards()
```

**预期输出：**
```
=== 偏移卡片统计 ===
偏移卡片数量: 15-30
总卡片数量: 96
偏移比例: 15-30%

前5个偏移卡片:
  card-5: 位置(1.5, 2.5), 层级3, 可见
  card-12: 位置(3.5, 4.5), 层级2, 被覆盖
  ...
```

### 特定卡片测试

```javascript
// 3. 检查特定卡片（替换为实际的卡片ID）
debugCardCoverage('card-10')
```

**预期输出：**
```
=== 卡片详情 ===
ID: card-10
位置: (1.5, 1.5)
层级: 2
类型: 3
状态: 可见✓

（如果被覆盖）
被以下卡片覆盖:
  - card-25: 位置(1.3, 1.3), 层级3
```

---

## 🎮 游戏测试

### 手动验证流程

1. **开始新游戏**
2. **观察可见卡片**
   - 顶层卡片应该都可见（非灰色）
   - 灰色卡片应该是被压住的
3. **点击上层卡片**
   - 卡片应该能够正常点击
   - 移入卡槽
4. **观察下层卡片**
   - 原本被压住的卡片应该变为可见
   - 可以正常点击
5. **继续游戏**
   - 能否正常三消？
   - 能否完全消除？

### 判断标准

| 情况 | 预期表现 |
|------|---------|
| 上层可见卡片 | 可以点击 ✓ |
| 灰色卡片 | 不能点击 ✓ |
| 移除上层后 | 下层变可见 ✓ |
| 三消功能 | 正常工作 ✓ |
| 最终结果 | 能完全消除 ✓ |

---

## 🔍 问题排查

### 如果仍然有问题

#### 问题1：太多卡片可见
```javascript
// 检查是否覆盖阈值太宽松
// 在 checkCardsOverlap() 中调整
const OVERLAP_THRESHOLD = 0.3; // 提高到30%
```

#### 问题2：太少卡片可见
```javascript
// 检查是否覆盖阈值太严格
// 在 checkCardsOverlap() 中调整
const OVERLAP_THRESHOLD = 0.15; // 降低到15%
```

#### 问题3：偏移卡片太多/太少
```javascript
// 在 generatePyramidPositions() 中调整
const useOffset = layer > 0 && Math.random() > 0.3; // 改为70%概率
// 或
const useOffset = layer > 0 && Math.random() > 0.7; // 改为30%概率
```

---

## 🎯 覆盖规则说明

### 规则1：中心点在范围内
```
上层卡片范围：[x, x+1] × [y, y+1]
下层卡片中心：(x', y')

判定：x <= x' <= x+1 AND y <= y' <= y+1
结果：被覆盖
```

### 规则2：重叠面积≥25%
```
重叠面积 / 下层面积 >= 0.25
结果：被覆盖
```

### 综合判定
```
满足规则1 OR 规则2 → 被覆盖
否则 → 可见
```

---

## 📊 修复效果

### Before（修复前）
```
问题：
✗ 50%阈值太严格
✗ 偏移卡片无法覆盖周围卡片
✗ 下方卡片显示混乱

用户体验：
- 下方有些卡片永远不可点击
- 游戏无法继续
- 用户困惑
```

### After（修复后）
```
改进：
✓ 中心点检测（主要）
✓ 25%阈值（辅助）
✓ 边界判断优化

用户体验：
✓ 覆盖关系清晰准确
✓ 移除上层后下方正确显示
✓ 游戏流畅进行
✓ 符合直觉
```

---

## 💡 设计说明

### 金字塔式覆盖

**物理直觉：**
一张卡片压在另一张卡片上，只要中心点被压住，整张卡片就不能取出。

**游戏设计：**
```
场景1：完全对齐
┌─┐
│A│ 位置(1,1)
└─┘
┌─┐
│1│ 位置(1,1)，中心(1.5,1.5)
└─┘

A的范围：[1,2]×[1,2]
1的中心：(1.5, 1.5)
判定：中心在范围内 ✓ 被覆盖
```

```
场景2：偏移堆叠
    ┌─┐
    │A│ 位置(1.5,1.5)
    └─┘
┌─┐┌─┐
│1││2│ 位置(1,1)和(1,2)
└─┘└─┘

A的范围：[1.5,2.5]×[1.5,2.5]
1的中心：(1.5, 1.5) ✓ 在范围内
2的中心：(1.5, 2.5) ✓ 在范围内
判定：都被覆盖
```

```
场景3：未覆盖
┌─┐      ┌─┐
│A│      │1│
└─┘      └─┘
位置(1,1) 位置(3,3)

A的范围：[1,2]×[1,2]
1的中心：(3.5, 3.5)
判定：中心不在范围内 ✗ 未覆盖
```

---

## 🧪 完整测试清单

### 测试1：基本覆盖
- [ ] 完全对齐的卡片能正确覆盖
- [ ] 被覆盖的卡片显示为灰色
- [ ] 可见卡片可以点击

### 测试2：偏移覆盖
- [ ] 偏移0.5格的卡片能覆盖周围4张
- [ ] 覆盖关系符合视觉直觉
- [ ] 移除后下方正确显示

### 测试3：边缘情况
- [ ] 边界处的卡片正确判定
- [ ] 无覆盖时正确显示可见
- [ ] 多层嵌套覆盖正确

### 测试4：完整游戏
- [ ] 能够正常进行游戏
- [ ] 三消功能正常
- [ ] 能够完全消除（100%可解）

---

## 🔄 如果还有问题

### 方案A：进一步降低阈值
```javascript
const OVERLAP_THRESHOLD = 0.15; // 15%
```

### 方案B：只使用中心点检测
```javascript
// 注释掉面积检测部分
// 只保留中心点检测
return centerInside;
```

### 方案C：调整偏移概率
```javascript
// 减少偏移卡片
const useOffset = layer > 0 && Math.random() > 0.7; // 30%概率
```

---

## 📞 技术支持

### 调试步骤
1. 刷新浏览器
2. 打开控制台（F12）
3. 运行 `debugCoverage()`
4. 检查输出是否合理
5. 如有问题，记录详细信息

### 问题报告
如果问题仍然存在，请提供：
- 控制台输出
- 游戏截图
- 具体复现步骤

---

**修复版本：** v2.0.3.1  
**修复日期：** 2026-01-28  
**修复内容：** 覆盖检测算法优化

---

*让覆盖检测更精准，让游戏更流畅！* 🎯
